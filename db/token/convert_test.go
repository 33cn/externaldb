package token

import (
	"testing"

	"github.com/33cn/externaldb/db"
	"github.com/33cn/externaldb/util"
	"github.com/stretchr/testify/assert"
)

func init() {
	util.InitChain33("local", "bty", "../../testdata/chain33.toml")
}

func TestConvert_ConvertTx(t *testing.T) {
	convert := NewConvert("", "bty", nil)
	convertTokenPrecreate(t, convert)
	convertTokenFinishedCreate(t, convert)

	convertTokenBurn(t, convert)
	convertTokenMint(t, convert)
	convertTokenTransfer(t, convert)
	convertTokenTransferToExec(t, convert)
	convertTokenWithdraw(t, convert)
}

func convertTokenPrecreate(t *testing.T, convert db.ExecConvert) {
	blockByte := "0aad071220d29ccba4a90178614c8036f962201fdf56e77b419ca570371778e129a0e0e2841a20dd690056e7719d5b5fd1ad3e76f3b4366db9f3278ca29fbe4fc523bbf756fa8a222064cdbc89fe14ae7b851a71e41bd36a82db8cd3b69f4434f6420b279fea4fd25028e90330d386c4ea053a99040a067469636b657412ed02501022e80208ffff8bf8011080cab5ee011a70313271796f6361794e46374c7636433971573461767873324537553431664b5366763a3078386434663130653666313762616533636538663764303239616263623461393839616563333333386238386662333537656165663035613265326465373930343a30303030303035363533224230783537656632356366363036613734393462626164326432666233373734316137636332346663663066653064303637363638636564306235653961363735336632206b9836b2d295ca16634ea83359342db3ab1ab5f15200993bf6a09024089b7b693a810136f5a704a427a0562653345659193a0e292f16200ce67d6a8f8af631149a904fb80f0c12f525f7ce208fbf2183f2052af6252a108bb2614db0ccf8d91d4e910a04c472f5113275fe937f68ed6b2b0b522cc5fc2594b9fec60c0b22524b828333aaa982be125ec0f69645c86de3d331b26aa84c29a06824e977ce51f76f34f0629c1a6d080112210320bbac09528e19c55b0f89cb37ab265e7e856b1a8c388780322dbbfd194b52ba1a46304402200971163de32cb6a17e925eb3fcec8a0ccc193493635ecbf52357f5365edc2c82022039d84aa7078bc51ef83536038b7fd83087bf4deb965370f211a5589d4add551720a08d063097c5abcc9db1e4a92b3a22313668747663424e53454137665a6841644c4a706844775152514a614870794854703af4010a05746f6b656e124438070a400a0879696e6865626962120541424344452080d0dbc3f4022864322231513868474c666f47653633656665576138664a34506e756b686b6e677436706f4b38011a6d08011221021afd97c3d9a47f7ead3ca34fe5a73789714318df2c608cf2c7962378dc858ecb1a4630440220316a241f19b392e685ef940dee48dc53f90fc5c8be108ceeef1d3c65f530ee5f02204c89708cc7dac408a88e9fa6ad8e723d93fc18fe114d4a416e280f5a15656b0920a08d0628ca87c4ea0530dd91be81ae9ed1882d3a22313268704a4248796268316d537943696a51324d514a506b377a376b5a376a6e516158ffff8bf80162200b97166ad507aea57a4bb6e6b9295ec082cdc670b8468a83b559dbd900ffb83068e90312e80508021a5e0802125a0a2b1080978dcaef192222313271796f6361794e46374c7636433971573461767873324537553431664b536676122b10e08987caef192222313271796f6361794e46374c7636433971573461767873324537553431664b5366761a9f010871129a010a70313271796f6361794e46374c7636433971573461767873324537553431664b5366763a3078386434663130653666313762616533636538663764303239616263623461393839616563333333386238386662333537656165663035613265326465373930343a30303030303035363533100218012222313271796f6361794e46374c7636433971573461767873324537553431664b5366761a620805125e0a2d1080e0cd90f6a6ca342222313668747663424e53454137665a6841644c4a706844775152514a61487079485470122d1080aa83fff7a6ca342222313668747663424e53454137665a6841644c4a706844775152514a614870794854701a870108081282010a22313668747663424e53454137665a6841644c4a706844775152514a61487079485470122d1880f0cae386e68611222231344b454b6259744b4b516d34774d7468534b394a344c61346e41696964476f7a741a2d1880ba80d288e68611222231344b454b6259744b4b516d34774d7468534b394a344c61346e41696964476f7a741a620805125e0a2d1080aa83fff7a6ca342222313668747663424e53454137665a6841644c4a706844775152514a61487079485470122d1080f0898ef9a6ca342222313668747663424e53454137665a6841644c4a706844775152514a614870794854701a8f010808128a010a22313668747663424e53454137665a6841644c4a706844775152514a6148707948547012311080e0ba84bf03188090c0ac622222314251585336547861595947356d41446157696a344178685a5a55547077393561351a311080e0ba84bf031880d6c6bb632222314251585336547861595947356d41446157696a344178685a5a555470773935613512970208021a5c080212580a2a10c099b8c321222231513868474c666f47653633656665576138664a34506e756b686b6e677436706f4b122a10a08cb2c321222231513868474c666f47653633656665576138664a34506e756b686b6e677436706f4b1a82010809127e0a22313268704a4248796268316d537943696a51324d514a506b377a376b5a376a6e5161122a108094ebdc03222231513868474c666f47653633656665576138664a34506e756b686b6e677436706f4b1a2c109c93ebdc031864222231513868474c666f47653633656665576138664a34506e756b686b6e677436706f4b1a3008d301122b0a054142434445122231513868474c666f47653633656665576138664a34506e756b686b6e677436706f4b"
	index := int64(1)
	env, err := util.GenEnv(blockByte, index)
	assert.Nil(t, err)

	records, err := convert.ConvertTx(env, db.OpAdd)
	assert.Nil(t, err)

	assert.Equal(t, 4, len(records))
	assert.Equal(t, "token_info/token_info/ABCDE", records[0].Key())
	assert.Equal(t, `{"name":"yinhebib","symbol":"ABCDE","amount":100000000000,"owner":"1Q8hGLfoGe63efeWa8fJ4Pnukhkngt6poK","creator":"1Q8hGLfoGe63efeWa8fJ4Pnukhkngt6poK","price":100,"category":1,"prepare_height":489}`, string(records[0].Value()))
}

func convertTokenFinishedCreate(t *testing.T, convert db.ExecConvert) {
	blockByte := "0a9a071220d8db75d4c4b0ee8a63568a74c8043ba3e18195b82e11a425f0afb00ea2d92f6d1a20563bb439cfed46ebc886a1b4fc66296100f4a2eaafade50c0f7f4a889740fe172220ff55da75fd42daba10740795e5b28ed2fbc4a72bbbf3ec133a1d5ca124900f2128ed0330d986c4ea053a9a040a067469636b657412ed02501022e80208ffff8bf8011080cab5ee011a70313271796f6361794e46374c7636433971573461767873324537553431664b5366763a3078386434663130653666313762616533636538663764303239616263623461393839616563333333386238386662333537656165663035613265326465373930343a30303030303039303830224230783537656632356366363036613734393462626164326432666233373734316137636332346663663066653064303637363638636564306235653961363735336632200debb0196ac0a686e6cfb2fd55aa019b205ac88c259279c57d4ee0e003b54e433a81015e975f32bad56022caf7dbb536f9bd72ac838e96e18ca205b86613d926a18a517aad7b1130c6dd465b1f2e92878fee45aebc1ec52b99ac6172e0b4963b1ee24004b16a2400bde739b7b490d9dcdd495d296db727dd3567505978d9686e31aaa56c1dc307221c398c3c50024dc4369f4c4de164b353e77603886d06400bc70501361a6e080112210320bbac09528e19c55b0f89cb37ab265e7e856b1a8c388780322dbbfd194b52ba1a473045022100884a169fcee26428b98ad2459fa0205507012fc34e1dc9fd4febe0ab8e08543d02202a7502143e2ddccb12c84ac8d97e28fb83aebadf3d4f62fe2d239787c2e2bcc620a08d0630d2868ea4bab4e5fd393a22313668747663424e53454137665a6841644c4a706844775152514a614870794854703ae0010a05746f6b656e122f3808122b0a054142434445122231513868474c666f47653633656665576138664a34506e756b686b6e677436706f4b1a6e08011221021afd97c3d9a47f7ead3ca34fe5a73789714318df2c608cf2c7962378dc858ecb1a473045022100ff552194bdd29e5f66807f4875821b0a3f0d1167953ab6ad1066ad7501cb62ca02200a86e41c683ca0bd6ef44764d1d3ffad49dbf481128f5d8f470e4024d5dbab8d20a08d0628cd87c4ea0530b292bd8efc93e2e9113a22313268704a4248796268316d537943696a51324d514a506b377a376b5a376a6e516158ffff8bf80162203d8f88fb4fefc58f0b9f2b0259fd8e6a82a033544f4798d4063dd0f29506890568ed0312e80508021a5e0802125a0a2b1080e2f4c9ef192222313271796f6361794e46374c7636433971573461767873324537553431664b536676122b10e0d4eec9ef192222313271796f6361794e46374c7636433971573461767873324537553431664b5366761a9f010871129a010a70313271796f6361794e46374c7636433971573461767873324537553431664b5366763a3078386434663130653666313762616533636538663764303239616263623461393839616563333333386238386662333537656165663035613265326465373930343a30303030303039303830100218012222313271796f6361794e46374c7636433971573461767873324537553431664b5366761a620805125e0a2d1080a0be8682a7ca342222313668747663424e53454137665a6841644c4a706844775152514a61487079485470122d1080eaf3f483a7ca342222313668747663424e53454137665a6841644c4a706844775152514a614870794854701a870108081282010a22313668747663424e53454137665a6841644c4a706844775152514a61487079485470122d188098a19d8ee68611222231344b454b6259744b4b516d34774d7468534b394a344c61346e41696964476f7a741a2d1880e2d68b90e68611222231344b454b6259744b4b516d34774d7468534b394a344c61346e41696964476f7a741a620805125e0a2d1080eaf3f483a7ca342222313668747663424e53454137665a6841644c4a706844775152514a61487079485470122d1080b0fa8385a7ca342222313668747663424e53454137665a6841644c4a706844775152514a614870794854701a8f010808128a010a22313668747663424e53454137665a6841644c4a706844775152514a6148707948547012311080e0ba84bf031880a8dae8662222314251585336547861595947356d41446157696a344178685a5a55547077393561351a311080e0ba84bf031880eee0f7672222314251585336547861595947356d41446157696a344178685a5a555470773935613512ea0308021a5c080212580a2a10a08cb2c321222231513868474c666f47653633656665576138664a34506e756b686b6e677436706f4b122a1080ffabc321222231513868474c666f47653633656665576138664a34506e756b686b6e677436706f4b1a82010806127e0a22313268704a4248796268316d537943696a51324d514a506b377a376b5a376a6e5161122c109c93ebdc031864222231513868474c666f47653633656665576138664a34506e756b686b6e677436706f4b1a2a109c93ebdc03222231513868474c666f47653633656665576138664a34506e756b686b6e677436706f4b1a76080612720a22313268704a4248796268316d537943696a51324d514a506b377a376b5a376a6e516112242222314251585336547861595947356d41446157696a344178685a5a55547077393561351a2610642222314251585336547861595947356d41446157696a344178685a5a55547077393561351a57080b12530a24222231513868474c666f47653633656665576138664a34506e756b686b6e677436706f4b122b1080d0dbc3f402222231513868474c666f47653633656665576138664a34506e756b686b6e677436706f4b1a3208d401122d0a054142434445122231513868474c666f47653633656665576138664a34506e756b686b6e677436706f4b1801"
	index := int64(1)
	env, err := util.GenEnv(blockByte, index)
	assert.Nil(t, err)

	records, err := convert.ConvertTx(env, db.OpAdd)
	assert.Nil(t, err)

	assert.Equal(t, 6, len(records))
	assert.Equal(t, "token_info/token_info/ABCDE", records[1].Key())
	assert.Equal(t, `{"status":1,"create_height":493}`, string(records[1].Value()))
}

func convertTokenBurn(t *testing.T, convert db.ExecConvert) {
	blockByte := "0af806122087c77c9db981421608d41980f278a657d2272767f6b2313e5cfba266522c5d4e1a20d84edbad2cff180b25f19e6d38e441075bd082ad819a94b253776d9d663516312220cfb1636c65d27933c856c353e3675ba9d83fcaa0f60d0cacce28781351202ba828ef0330dd86c4ea053a9a040a067469636b657412ed02501022e80208ffff8bf8011080cab5ee011a70313271796f6361794e46374c7636433971573461767873324537553431664b5366763a3078386434663130653666313762616533636538663764303239616263623461393839616563333333386238386662333537656165663035613265326465373930343a30303030303039353135224230783537656632356366363036613734393462626164326432666233373734316137636332346663663066653064303637363638636564306235653961363735336632203901d8f53161e8f7b4d2141aca3eafe61b9f9c58ea8de0d9a39756e50a888e173a8101eaeb15e70946ca7089cf7e3281d75923d13a8b15e922619202d192fd68d99ca121c4fed2a26f175ad056a69877e17bb80b9ac2284a87f7917999fdd4ef7ee0e7042c69a5bb84da75457308e91de5365fe11ec938a882f4e22c7462308d02395e32006a3769573b6bb1a2b03d46d297a9bffddf1d3832060c208c0cab2b867374f51a6e080112210320bbac09528e19c55b0f89cb37ab265e7e856b1a8c388780322dbbfd194b52ba1a473045022100e92eb1251a2b5f204d23ca6a8c3015ec9b5a534559c45fd9a53d3a42aefc8d15022028bf3f3d1334faee171ab8143b3fce3403a7af3632f82dfde42d9a80de86064620a08d0630c9fba4ae86cee6b8673a22313668747663424e53454137665a6841644c4a706844775152514a614870794854703abe010a05746f6b656e120e380d520a0a05414243444510904e1a6d08011221021afd97c3d9a47f7ead3ca34fe5a73789714318df2c608cf2c7962378dc858ecb1a463044022050247ec056b5871e2262f145718c1c873fc953d91c6f0cb3ebc39265f2230bf8022057cc725593b4c8c824bc8642a638dae9c2a22efa378978e11c887fa0149fbbb720a08d0628d387c4ea0530c18ee6858992eadc533a22313268704a4248796268316d537943696a51324d514a506b377a376b5a376a6e516158ffff8bf8016220e79820af7b6a918a10d0c0f7980199fff8c68a4d7913735e89a74051d722342268ef0312e80508021a5e0802125a0a2b10c0c7e8c9ef192222313271796f6361794e46374c7636433971573461767873324537553431664b536676122b10a0bae2c9ef192222313271796f6361794e46374c7636433971573461767873324537553431664b5366761a9f010871129a010a70313271796f6361794e46374c7636433971573461767873324537553431664b5366763a3078386434663130653666313762616533636538663764303239616263623461393839616563333333386238386662333537656165663035613265326465373930343a30303030303039353135100218012222313271796f6361794e46374c7636433971573461767873324537553431664b5366761a620805125e0a2d1080c0b68188a7ca342222313668747663424e53454137665a6841644c4a706844775152514a61487079485470122d10808aecef89a7ca342222313668747663424e53454137665a6841644c4a706844775152514a614870794854701a870108081282010a22313668747663424e53454137665a6841644c4a706844775152514a61487079485470122d1880ac8cfa91e68611222231344b454b6259744b4b516d34774d7468534b394a344c61346e41696964476f7a741a2d1880f6c1e893e68611222231344b454b6259744b4b516d34774d7468534b394a344c61346e41696964476f7a741a620805125e0a2d10808aecef89a7ca342222313668747663424e53454137665a6841644c4a706844775152514a61487079485470122d1080d0f2fe8aa7ca342222313668747663424e53454137665a6841644c4a706844775152514a614870794854701a8f010808128a010a22313668747663424e53454137665a6841644c4a706844775152514a6148707948547012311080e0ba84bf031880b4e786692222314251585336547861595947356d41446157696a344178685a5a55547077393561351a311080e0ba84bf031880faed956a2222314251585336547861595947356d41446157696a344178685a5a555470773935613512990308021a5c080212580a2a1080ffabc321222231513868474c666f47653633656665576138664a34506e756b686b6e677436706f4b122a10e0f1a5c321222231513868474c666f47653633656665576138664a34506e756b686b6e677436706f4b1ad60108c40212d0010a660a0879696e6865626962120541424344452080d0dbc3f4022864322231513868474c666f47653633656665576138664a34506e756b686b6e677436706f4b3a2231513868474c666f47653633656665576138664a34506e756b686b6e677436706f4b4001480112660a0879696e68656269621205414243444520f081dbc3f4022864322231513868474c666f47653633656665576138664a34506e756b686b6e677436706f4b3a2231513868474c666f47653633656665576138664a34506e756b686b6e677436706f4b400148011a5e080f125a0a2b1080d0dbc3f402222231513868474c666f47653633656665576138664a34506e756b686b6e677436706f4b122b10f081dbc3f402222231513868474c666f47653633656665576138664a34506e756b686b6e677436706f4b"
	index := int64(1)
	env, err := util.GenEnv(blockByte, index)

	assert.Nil(t, err)

	records, err := convert.ConvertTx(env, db.OpAdd)
	assert.Nil(t, err)

	assert.Equal(t, 4, len(records))
	assert.Equal(t, "token_info/token_info/ABCDE", records[1].Key())
	assert.Equal(t, `{"amount":99999990000}`, string(records[1].Value()))
}

func convertTokenMint(t *testing.T, convert db.ExecConvert) {
	blockByte := "0af706122012f4b33527196987c0b484863b3172ea3208bb563df439b8d3cafa3d43d122cd1a20e7fb009e247d885c07a10c41fe8cf15aaa405dcbf0710f34a71db480de9ea5dd2220a76e6f905955351d7c93ac9fd3c8b08ca62246ab509f4d753e85c4dc3b12c5d828f10330e486c4ea053a99040a067469636b657412ed02501022e80208ffff8bf8011080cab5ee011a70313271796f6361794e46374c7636433971573461767873324537553431664b5366763a3078386434663130653666313762616533636538663764303239616263623461393839616563333333386238386662333537656165663035613265326465373930343a3030303030303730323622423078353765663235636636303661373439346262616432643266623337373431613763633234666366306665306430363736363863656430623565396136373533663220000ac87180df25a13bbd916db63c9734c26818e2f4314b89137d46c160746e1a3a810185cbf7e4dc179eace994308033ca15be14dd1d4663ecf056da1566d77a6950885056ec733b294cbf221a03b9ec76d8065970b0bea55ae36005935c2468750e5f04407c955ba34aa3de2c0b59639d961fc2170db3bddf0007162903fd55471079905697fef8ee9e36447e9247addcfd635e7400643ff25ea955e359edd4c03c726c1a6d080112210320bbac09528e19c55b0f89cb37ab265e7e856b1a8c388780322dbbfd194b52ba1a46304402205300e97bf60a9d8988e90147df8c3d502386d325509271ea6cac1dc860b5aa8802203d9cbb9d0b4c2d35a16f8bf44e8e20ee9df97b7abf5bab0e52c931e6fe34b59120a08d0630c1e5928bb588e3ed4f3a22313668747663424e53454137665a6841644c4a706844775152514a614870794854703abe010a05746f6b656e120e380c4a0a0a05414243444510904e1a6d08011221021afd97c3d9a47f7ead3ca34fe5a73789714318df2c608cf2c7962378dc858ecb1a46304402201a90619e5332db23112e9ee86714b66aebe8f1aa0e7bca6e54c7bfde556ff9de02207905a7235c0840fc57999b8c399d977ae5d18dce907f21112d2e31e12502f60820a08d0628d887c4ea0530988d9bf7b3eaaa8b033a22313268704a4248796268316d537943696a51324d514a506b377a376b5a376a6e516158ffff8bf80162201ad3c5a8d4226a8d883b3508d45dd04e22383d1cb6f339fd6616c7192426fb2d68f10312e80508021a5e0802125a0a2b1080addcc9ef192222313271796f6361794e46374c7636433971573461767873324537553431664b536676122b10e09fd6c9ef192222313271796f6361794e46374c7636433971573461767873324537553431664b5366761a9f010871129a010a70313271796f6361794e46374c7636433971573461767873324537553431664b5366763a3078386434663130653666313762616533636538663764303239616263623461393839616563333333386238386662333537656165663035613265326465373930343a30303030303037303236100218012222313271796f6361794e46374c7636433971573461767873324537553431664b5366761a620805125e0a2d1080e0aefc8da7ca342222313668747663424e53454137665a6841644c4a706844775152514a61487079485470122d1080aae4ea8fa7ca342222313668747663424e53454137665a6841644c4a706844775152514a614870794854701a870108081282010a22313668747663424e53454137665a6841644c4a706844775152514a61487079485470122d1880c0f7d695e68611222231344b454b6259744b4b516d34774d7468534b394a344c61346e41696964476f7a741a2d18808aadc597e68611222231344b454b6259744b4b516d34774d7468534b394a344c61346e41696964476f7a741a620805125e0a2d1080aae4ea8fa7ca342222313668747663424e53454137665a6841644c4a706844775152514a61487079485470122d1080f0eaf990a7ca342222313668747663424e53454137665a6841644c4a706844775152514a614870794854701a8f010808128a010a22313668747663424e53454137665a6841644c4a706844775152514a6148707948547012311080e0ba84bf031880c0f4a46b2222314251585336547861595947356d41446157696a344178685a5a55547077393561351a311080e0ba84bf03188086fbb36c2222314251585336547861595947356d41446157696a344178685a5a555470773935613512990308021a5c080212580a2a10e0f1a5c321222231513868474c666f47653633656665576138664a34506e756b686b6e677436706f4b122a10c0e49fc321222231513868474c666f47653633656665576138664a34506e756b686b6e677436706f4b1ad60108c30212d0010a660a0879696e68656269621205414243444520f081dbc3f4022864322231513868474c666f47653633656665576138664a34506e756b686b6e677436706f4b3a2231513868474c666f47653633656665576138664a34506e756b686b6e677436706f4b4001480112660a0879696e6865626962120541424344452080d0dbc3f4022864322231513868474c666f47653633656665576138664a34506e756b686b6e677436706f4b3a2231513868474c666f47653633656665576138664a34506e756b686b6e677436706f4b400148011a5e080e125a0a2b10f081dbc3f402222231513868474c666f47653633656665576138664a34506e756b686b6e677436706f4b122b1080d0dbc3f402222231513868474c666f47653633656665576138664a34506e756b686b6e677436706f4b"
	index := int64(1)
	env, err := util.GenEnv(blockByte, index)
	assert.Nil(t, err)

	records, err := convert.ConvertTx(env, db.OpAdd)
	assert.Nil(t, err)

	assert.Equal(t, 4, len(records))
	assert.Equal(t, "token_info/token_info/ABCDE", records[1].Key())
	assert.Equal(t, `{"amount":100000000000}`, string(records[1].Value()))
}

func convertTokenTransfer(t *testing.T, convert db.ExecConvert) {
	blockByte := "0a9f07122032a8d2bceef77b42a2a632aff036604cdc365c26e822ea1f4f53e16ad852f4fa1a20fafa159d33f2bfb0490d02364820179ea940c93bbfb0a58459321abb2fe1d44b22206eb7b64b8c2abde975eb5334ae414f08841d7301b8ecd4985eb784218b5f872528f30330e786c4ea053a9a040a067469636b657412ed02501022e80208ffff8bf8011080cab5ee011a70313271796f6361794e46374c7636433971573461767873324537553431664b5366763a3078386434663130653666313762616533636538663764303239616263623461393839616563333333386238386662333537656165663035613265326465373930343a3030303030303633343822423078353765663235636636303661373439346262616432643266623337373431613763633234666366306665306430363736363863656430623565396136373533663220222ef267f41f3450ae8436129d0da0628fbc92493825d793b2cbdc6f2cacc43b3a810138edad10f6d79f9691b896857a601ddd4e04f76d47a0ba5eace5246c4096eaea677df01d9eb9bb17efe0584945b0e8372e7aa2604f9cc5a9628b28f60cc8aacd047a8f0b64e556914b9b79bba2c4110e1cd5330ae9988fc97e3dc2123a68c1b3ad443ffe0d6751c3985fca2ebf42e9f3c2a73ed6b359901e48ca7291252efa34f51a6e080112210320bbac09528e19c55b0f89cb37ab265e7e856b1a8c388780322dbbfd194b52ba1a473045022100995be0a4ce253e26020770b67a9b7c13c7432bae5735449b964f7b46434d491a02201b4560d43fcceb17de3254a1aec2fe5219b9a6e6c0ecc4e2aea9e17a0e0a99f120a08d0630efa588d0878cdfbf7a3a22313668747663424e53454137665a6841644c4a706844775152514a614870794854703ae5010a05746f6b656e1235380422310a054142434445108094ebdc03222231344b454b6259744b4b516d34774d7468534b394a344c61346e41696964476f7a741a6d08011221021afd97c3d9a47f7ead3ca34fe5a73789714318df2c608cf2c7962378dc858ecb1a463044022047994addd1e8a839c8bc6f5fd434ef18112e252e27f6f86877b2d41c065daf8f022032e1efdccffe9c01d2188916378dd493356a4f88893d852df3a44fd0d4243aa220a08d0628dc87c4ea0530e28ac5c482f487df183a2231344b454b6259744b4b516d34774d7468534b394a344c61346e41696964476f7a7458ffff8bf80162208dcc0bd809fa36c1c672d9d51a60856dff54d2f6626208364a45c6b12d4fda0e68f30312e80508021a5e0802125a0a2b10c092d0c9ef192222313271796f6361794e46374c7636433971573461767873324537553431664b536676122b10a085cac9ef192222313271796f6361794e46374c7636433971573461767873324537553431664b5366761a9f010871129a010a70313271796f6361794e46374c7636433971573461767873324537553431664b5366763a3078386434663130653666313762616533636538663764303239616263623461393839616563333333386238386662333537656165663035613265326465373930343a30303030303036333438100218012222313271796f6361794e46374c7636433971573461767873324537553431664b5366761a620805125e0a2d108080a7f793a7ca342222313668747663424e53454137665a6841644c4a706844775152514a61487079485470122d1080cadce595a7ca342222313668747663424e53454137665a6841644c4a706844775152514a614870794854701a870108081282010a22313668747663424e53454137665a6841644c4a706844775152514a61487079485470122d1880d4e2b399e68611222231344b454b6259744b4b516d34774d7468534b394a344c61346e41696964476f7a741a2d18809e98a29be68611222231344b454b6259744b4b516d34774d7468534b394a344c61346e41696964476f7a741a620805125e0a2d1080cadce595a7ca342222313668747663424e53454137665a6841644c4a706844775152514a61487079485470122d108090e3f496a7ca342222313668747663424e53454137665a6841644c4a706844775152514a614870794854701a8f010808128a010a22313668747663424e53454137665a6841644c4a706844775152514a6148707948547012311080e0ba84bf031880cc81c36d2222314251585336547861595947356d41446157696a344178685a5a55547077393561351a311080e0ba84bf0318809288d26e2222314251585336547861595947356d41446157696a344178685a5a555470773935613512980208021a5c080212580a2a10c0e49fc321222231513868474c666f47653633656665576138664a34506e756b686b6e677436706f4b122a10a0d799c321222231513868474c666f47653633656665576138664a34506e756b686b6e677436706f4b1a5e0803125a0a2b1080d0dbc3f402222231513868474c666f47653633656665576138664a34506e756b686b6e677436706f4b122b1080bcf0e6f002222231513868474c666f47653633656665576138664a34506e756b686b6e677436706f4b1a56080312520a24222231344b454b6259744b4b516d34774d7468534b394a344c61346e41696964476f7a74122a108094ebdc03222231344b454b6259744b4b516d34774d7468534b394a344c61346e41696964476f7a74"
	index := int64(1)
	env, err := util.GenEnv(blockByte, index)
	assert.Nil(t, err)

	records, err := convert.ConvertTx(env, db.OpAdd)
	assert.Nil(t, err)

	assert.Equal(t, 4, len(records))
	assert.Equal(t, "transaction/transaction/0xe343916db0587f4fe147d2c535734e5803bf00c28df982ca1e623c06dc997ffd", records[0].Key())
	assert.Equal(t, `{"height_index":49900001,"height":499,"block_time":1565590375,"block_hash":"0xbf374f3030b7650e84b1eeb767e495f167366a57a223a0de2f748ab2f2234376","success":true,"index":1,"hash":"0xe343916db0587f4fe147d2c535734e5803bf00c28df982ca1e623c06dc997ffd","from":"1Q8hGLfoGe63efeWa8fJ4Pnukhkngt6poK","to":"14KEKbYtKKQm4wMthSK9J4La4nAiidGozt","execer":"token","amount":1000000000,"fee":100000,"action_name":"transfer","group_count":0,"is_withdraw":false,"options":{"symbol":"ABCDE","to":"14KEKbYtKKQm4wMthSK9J4La4nAiidGozt"},"assets":[{"exec":"token","symbol":"ABCDE","amount":1000000000}],"next":"","is_para":false}`, string(records[0].Value()))
}

func convertTokenTransferToExec(t *testing.T, convert db.ExecConvert) {
	blockByte := "0aa2071220b37c85d2cbb54e84976b7106789f9806e2f5039ecd65646ac258d4c0bca84bcb1a20a4cb153741ad453fea9a1fc9834754feb96e99877af032c955df1b8e7ba6285922201537ed3f8f50e5a4dc01e17ae7ff90f0b5b4b0cfa749fbadc9bc2c18cb3b9d1328f50330ed86c4ea053a9a040a067469636b657412ed02501022e80208ffff8bf8011080cab5ee011a70313271796f6361794e46374c7636433971573461767873324537553431664b5366763a3078386434663130653666313762616533636538663764303239616263623461393839616563333333386238386662333537656165663035613265326465373930343a303030303030393731372242307835376566323563663630366137343934626261643264326662333737343161376363323466636630666530643036373636386365643062356539613637353366322026604b2dadffb8ebf6fc838014f002349e99a2a6f1ce374bb739f039ae25b8403a81017d02c2224c198c0ed57ebda8b631d456b7fe5e40497216dba0e90333fed0e7199b1abdcf1cd3efce5c4b8263c8d052aa39f534de2e5aa7dbd3c3cfb1a39228180436933b76c8328c17d6ab439a59709768a3b27ab9f4be7738a4f515e1fc5140063bdb85aec6270c6aee787a3952c4c531a525e6f0565f0135fa62a9c6c81c4b3a1a6e080112210320bbac09528e19c55b0f89cb37ab265e7e856b1a8c388780322dbbfd194b52ba1a4730450221009090497d1597ff05c643499bd7a44867639efdc8d115904f135548c2988b439e0220592f455e0a848dade1831dfb348ac87fbdbc649567f474a847bb50e8c4ad5b8c20a08d0630e9ffeee3e1c1b381443a22313668747663424e53454137665a6841644c4a706844775152514a614870794854703ae8010a05746f6b656e1238380b42340a054142434445100a2205746f6b656e2a22313268704a4248796268316d537943696a51324d514a506b377a376b5a376a6e51611a6d08011221021afd97c3d9a47f7ead3ca34fe5a73789714318df2c608cf2c7962378dc858ecb1a4630440220213c1a352c426112aa965bd4c316e7231cf326988449fd3a382bf6acd69853650220518e67734a88e80b0285742732290cecd581069b84a187413ce7a11a6a7b5b4020a08d0628e087c4ea0530bfdab1f88b82beab643a22313268704a4248796268316d537943696a51324d514a506b377a376b5a376a6e516158ffff8bf801622066b08d447b91378611071537d8ea8b24d1d03c16519d848ae8e4ba627de5033768f50312e80508021a5e0802125a0a2b1080f8c3c9ef192222313271796f6361794e46374c7636433971573461767873324537553431664b536676122b10e0eabdc9ef192222313271796f6361794e46374c7636433971573461767873324537553431664b5366761a9f010871129a010a70313271796f6361794e46374c7636433971573461767873324537553431664b5366763a3078386434663130653666313762616533636538663764303239616263623461393839616563333333386238386662333537656165663035613265326465373930343a30303030303039373137100218012222313271796f6361794e46374c7636433971573461767873324537553431664b5366761a620805125e0a2d1080a09ff299a7ca342222313668747663424e53454137665a6841644c4a706844775152514a61487079485470122d1080ead4e09ba7ca342222313668747663424e53454137665a6841644c4a706844775152514a614870794854701a870108081282010a22313668747663424e53454137665a6841644c4a706844775152514a61487079485470122d1880e8cd909de68611222231344b454b6259744b4b516d34774d7468534b394a344c61346e41696964476f7a741a2d1880b283ff9ee68611222231344b454b6259744b4b516d34774d7468534b394a344c61346e41696964476f7a741a620805125e0a2d1080ead4e09ba7ca342222313668747663424e53454137665a6841644c4a706844775152514a61487079485470122d1080b0dbef9ca7ca342222313668747663424e53454137665a6841644c4a706844775152514a614870794854701a8f010808128a010a22313668747663424e53454137665a6841644c4a706844775152514a6148707948547012311080e0ba84bf031880d88ee16f2222314251585336547861595947356d41446157696a344178685a5a55547077393561351a311080e0ba84bf0318809e95f0702222314251585336547861595947356d41446157696a344178685a5a5554707739356135128c0308021a5c080212580a2a10a0d799c321222231513868474c666f47653633656665576138664a34506e756b686b6e677436706f4b122a1080ca93c321222231513868474c666f47653633656665576138664a34506e756b686b6e677436706f4b1a5e0803125a0a2b1080bcf0e6f002222231513868474c666f47653633656665576138664a34506e756b686b6e677436706f4b122b10f6bbf0e6f002222231513868474c666f47653633656665576138664a34506e756b686b6e677436706f4b1a520803124e0a242222313268704a4248796268316d537943696a51324d514a506b377a376b5a376a6e51611226100a2222313268704a4248796268316d537943696a51324d514a506b377a376b5a376a6e51611a76080812720a22313268704a4248796268316d537943696a51324d514a506b377a376b5a376a6e51611224222231513868474c666f47653633656665576138664a34506e756b686b6e677436706f4b1a26100a222231513868474c666f47653633656665576138664a34506e756b686b6e677436706f4b"
	index := int64(1)
	env, err := util.GenEnv(blockByte, index)
	assert.Nil(t, err)

	records, err := convert.ConvertTx(env, db.OpAdd)
	assert.Nil(t, err)

	assert.Equal(t, 5, len(records))
	assert.Equal(t, "transaction/transaction/0xe4a8a1bf1fd560bd1db281d23e08de0f6a38cda464ed6369c9d5b856cc3d4d73", records[0].Key())
	assert.Equal(t, `{"height_index":50100001,"height":501,"block_time":1565590381,"block_hash":"0xe1af68260d64f2150602831c63e11389e8a01f02278c757386624454bcfdda0a","success":true,"index":1,"hash":"0xe4a8a1bf1fd560bd1db281d23e08de0f6a38cda464ed6369c9d5b856cc3d4d73","from":"1Q8hGLfoGe63efeWa8fJ4Pnukhkngt6poK","to":"12hpJBHybh1mSyCijQ2MQJPk7z7kZ7jnQa","execer":"token","amount":10,"fee":100000,"action_name":"transferToExec","group_count":0,"is_withdraw":false,"options":{"symbol":"ABCDE","to":"12hpJBHybh1mSyCijQ2MQJPk7z7kZ7jnQa","exec_name":"token"},"assets":[{"exec":"token","symbol":"ABCDE","amount":10}],"next":"","is_para":false}`, string(records[0].Value()))
}

func convertTokenWithdraw(t *testing.T, convert db.ExecConvert) {
	blockByte := "0aa107122041122145b38fd4067307ea81f0db35688086b82b950d10e5fb1a5f0fdbdbfef51a20aaee8018a2ad1483f1b1f84f48403234da83105092051007a8daa0cfb7393c8722203efae25ad32dfdac2e53d6924405c42b338dd59701dca05575cb11eb86d50c1328f80330f086c4ea053a99040a067469636b657412ed02501022e80208ffff8bf8011080cab5ee011a70313271796f6361794e46374c7636433971573461767873324537553431664b5366763a3078386434663130653666313762616533636538663764303239616263623461393839616563333333386238386662333537656165663035613265326465373930343a30303030303039303731224230783537656632356366363036613734393462626164326432666233373734316137636332346663663066653064303637363638636564306235653961363735336632209198c346a89114b5db750f73cd12f3728552ac67b041070bc80f9af7354ffd5e3a8101d0d2382eda453f73796890613ae2f3a62168a7dfe35d23d00b7d57cb4faf949fe8dcaf9947a24ab48263e66e57bc69798f1e0d4f290559d976c8f9665231a48b04748dca7eb51d6bec78e3174f3019287571bd93ecfa60cd0bf28a5529f07a718a150a3c02d27e28c8c56a07c760c694c6d98e76db676b8492f5fd03f7115f8d7d1a6d080112210320bbac09528e19c55b0f89cb37ab265e7e856b1a8c388780322dbbfd194b52ba1a4630440220133b699a791b64ce7a398acecf43900518df51c711595852c53554ab7921a1f0022049d18f269154b631d1ed705e63900a27ab6a5eadc4a8636af068d84912b2036b20a08d0630c1a3b7d7c188ceda483a22313668747663424e53454137665a6841644c4a706844775152514a614870794854703ae8010a05746f6b656e123838062a340a054142434445100a2205746f6b656e2a22313268704a4248796268316d537943696a51324d514a506b377a376b5a376a6e51611a6d08011221021afd97c3d9a47f7ead3ca34fe5a73789714318df2c608cf2c7962378dc858ecb1a46304402200f86140b3289880a9c9b2c26e73f2820f46c4c81357051131eb66b1d48bacc1502200ac0a943d9ddd3f160dddbe624097765a444ce071dcf1fe92ea1ac91f34deadf20a08d0628e687c4ea0530d8d7daadaceac5a70e3a22313268704a4248796268316d537943696a51324d514a506b377a376b5a376a6e516158ffff8bf80162203bf370dd7568f63caa261cc341cc321b81b6417df0bbe8ac7afb691abef27d6568f80312e80508021a5e0802125a0a2b10a0d0b1c9ef192222313271796f6361794e46374c7636433971573461767873324537553431664b536676122b1080c3abc9ef192222313271796f6361794e46374c7636433971573461767873324537553431664b5366761a9f010871129a010a70313271796f6361794e46374c7636433971573461767873324537553431664b5366763a3078386434663130653666313762616533636538663764303239616263623461393839616563333333386238386662333537656165663035613265326465373930343a30303030303039303731100218012222313271796f6361794e46374c7636433971573461767873324537553431664b5366761a620805125e0a2d1080d0d3eaa2a7ca342222313668747663424e53454137665a6841644c4a706844775152514a61487079485470122d10809a89d9a4a7ca342222313668747663424e53454137665a6841644c4a706844775152514a614870794854701a870108081282010a22313668747663424e53454137665a6841644c4a706844775152514a61487079485470122d1880c6eedba2e68611222231344b454b6259744b4b516d34774d7468534b394a344c61346e41696964476f7a741a2d188090a4caa4e68611222231344b454b6259744b4b516d34774d7468534b394a344c61346e41696964476f7a741a620805125e0a2d10809a89d9a4a7ca342222313668747663424e53454137665a6841644c4a706844775152514a61487079485470122d1080e08fe8a5a7ca342222313668747663424e53454137665a6841644c4a706844775152514a614870794854701a8f010808128a010a22313668747663424e53454137665a6841644c4a706844775152514a6148707948547012311080e0ba84bf031880aaa28e732222314251585336547861595947356d41446157696a344178685a5a55547077393561351a311080e0ba84bf031880f0a89d742222314251585336547861595947356d41446157696a344178685a5a5554707739356135128c0308021a5c080212580a2a1080ca93c321222231513868474c666f47653633656665576138664a34506e756b686b6e677436706f4b122a10e0bc8dc321222231513868474c666f47653633656665576138664a34506e756b686b6e677436706f4b1a76080712720a22313268704a4248796268316d537943696a51324d514a506b377a376b5a376a6e51611226100a222231513868474c666f47653633656665576138664a34506e756b686b6e677436706f4b1a24222231513868474c666f47653633656665576138664a34506e756b686b6e677436706f4b1a520803124e0a26100a2222313268704a4248796268316d537943696a51324d514a506b377a376b5a376a6e516112242222313268704a4248796268316d537943696a51324d514a506b377a376b5a376a6e51611a5e0803125a0a2b10f6bbf0e6f002222231513868474c666f47653633656665576138664a34506e756b686b6e677436706f4b122b1080bcf0e6f002222231513868474c666f47653633656665576138664a34506e756b686b6e677436706f4b"
	index := int64(1)
	env, err := util.GenEnv(blockByte, index)
	assert.Nil(t, err)

	records, err := convert.ConvertTx(env, db.OpAdd)
	assert.Nil(t, err)

	assert.Equal(t, 5, len(records))
	assert.Equal(t, "transaction/transaction/0x78fdb38119ae5eb2a7d47e2800051697619c27a52bfeea4f93531471d8b4fd95", records[0].Key())
	assert.Equal(t, `{"height_index":50400001,"height":504,"block_time":1565590384,"block_hash":"0x9f11a0081bc5095f9be68d5ddd3d1ed8d5782d01f628ea9a38086401ccd9633b","success":true,"index":1,"hash":"0x78fdb38119ae5eb2a7d47e2800051697619c27a52bfeea4f93531471d8b4fd95","from":"1Q8hGLfoGe63efeWa8fJ4Pnukhkngt6poK","to":"12hpJBHybh1mSyCijQ2MQJPk7z7kZ7jnQa","execer":"token","amount":10,"fee":100000,"action_name":"withdraw","group_count":0,"is_withdraw":true,"options":{"symbol":"ABCDE","to":"12hpJBHybh1mSyCijQ2MQJPk7z7kZ7jnQa","exec_name":"token"},"assets":[{"exec":"token","symbol":"ABCDE","amount":10}],"next":"","is_para":false}`, string(records[0].Value()))
}
