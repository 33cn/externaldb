package coins_test

import (
	"testing"

	"github.com/stretchr/testify/assert"
	"github.com/33cn/externaldb/db"
	"github.com/33cn/externaldb/db/account"
	"github.com/33cn/externaldb/db/coins"
	"github.com/33cn/externaldb/db/transaction"
	"github.com/33cn/externaldb/util"
)

func init() {
	util.InitChain33("local", "bty", "../../testdata/chain33.toml")
}

// transfer withdraw transferToExec
// transfer 测试基本功能
// withdraw transferToExec 额外测试
func Test_ConvertTx(t *testing.T) {
	blockByte := "0aea071220cb6810299957802da8ebd0e18dc900ba5a3d6746352b42d703f11cf88c3f9d5c1a20bbdb455fd1674c3540b2c3cab944c625716331e74fc0e02f3cd519e363a17d962220e13c5d5f04761e59ffb554730e9bc353c47f8710c89b788b1dde3f33c74d4d3d28ab9dae0130b6d3e6e9053a90050a067469636b657412e403501022df0308d3de83f1011080cab5ee011ac4013145776b4b6439695531704c325a776d524143355272426f71464431614d7251323a3078316435663362393337386264666634346565313761356136363135343965613263623230383032386436633539636139313064336430383636366436333533353a303030303030303030303a323162356138653336366332646330383439663134383937303433333730643338656130613033393236356263323464396438616133646664343238646632663a3135363239363638303937383134343331313922423078643464643230623737373537336239343464613936376162326333613365666535333866326136313638326537353430306264623931623865336232616362622a20c30eb9a29a6b64a325efb6934a296207f80957221612bf73ededb47b4fa586ad3220714788f458028a1de087d7c258787cdb5b1e8a415ec3ac5dfcfaed1e21fae2c83a81011bb60bc2363a1a66d91ce10d6e374951b03f12f282fe7c51db3fd76ae9aee41eaffff651a4f271a52544983eeeab747a65205dbf67a24214d816bb111a4ebdd604d5dab2d232820d3e2b4ecf916e073a53071ed38a530fe2373f6f7630fb76d99725d824061a794176279b3cdbd9cbb070f6ac0a132d8c84e7ec920d89950be8b61a6d0801122103ee1171e51abe4d3dbd8b9a076d601663ad3f3f2f4f98d517d1f0c410a1fdd5b61a4630440220362018642640206432751187a19a090e2018122b05d33b8d2a4b53aca005ee440220418680ce93ee0f151d6813f1e942de1c804351eddfb4da7c9052701ce777ff5020a08d0630ade2bed7c397e9a5603a22313668747663424e53454137665a6841644c4a706844775152514a614870794854703ab6010a05636f696e73120b18010a071080f8dcf8c60e1a6e0801122102dd9744936ea82d4309b47e007456deb4ed4de77cec3ae2b155f86f8c9b503d8d1a473045022100d510ab5e2a989ea7d36382f07fd6e76c880625883ecd7c64891e505901896fbc02200b940f9d1608fca12530a1054b13b60726ba80873900d8d0f6c79a8db723decf20a08d0630adecb69efff4e8e1633a2231374a4745764445424569676a6f6f5a62646d746878615364384b6a35324265746558d3de83f1016220cab08f4999c4a0b43d97a06dfca66739b6d0ebb368777b93a38740e053f369e568ab9dae0112cc0608021a5c080212580a2a10bbb8bcebea0222213145776b4b6439695531704c325a776d524143355272426f71464431614d725132122a109babb6ebea0222213145776b4b6439695531704c325a776d524143355272426f71464431614d7251321af301087112ee010ac4013145776b4b6439695531704c325a776d524143355272426f71464431614d7251323a3078316435663362393337386264666634346565313761356136363135343965613263623230383032386436633539636139313064336430383636366436333533353a303030303030303030303a323162356138653336366332646330383439663134383937303433333730643338656130613033393236356263323464396438616133646664343238646632663a313536323936363830393738313434333131391002180122213145776b4b6439695531704c325a776d524143355272426f71464431614d7251321a620805125e0a2d10cdff80db98fdb8432222313668747663424e53454137665a6841644c4a706844775152514a61487079485470122d10cdc9b6c99afdb8432222313668747663424e53454137665a6841644c4a706844775152514a614870794854701a93010808128e010a22313668747663424e53454137665a6841644c4a706844775152514a61487079485470123310808a87d0251880b482a9edeb9d04222231457852524c6f4a5861384c7a58644e786e4a76426b564e5a7056773351574d69341a3310808a87d0251880feb797efeb9d04222231457852524c6f4a5861384c7a58644e786e4a76426b564e5a7056773351574d69341a620805125e0a2d10cdc9b6c99afdb8432222313668747663424e53454137665a6841644c4a706844775152514a61487079485470122d10cd8fbdd89bfdb8432222313668747663424e53454137665a6841644c4a706844775152514a614870794854701a950108081290010a22313668747663424e53454137665a6841644c4a706844775152514a6148707948547012341080c0958fc7d6e2041880bac89efa7f2222314a6d46614136756e724346594557504752693775755859314b7468544a784a45501a341080c0958fc7d6e204188080cfadfb7f2222314a6d46614136756e724346594557504752693775755859314b7468544a784a455012a60208021a600802125c0a2c10db88d09eccc16c22223146435839584a545a58765a74656167547265664a4542505a4d743842466d646f69122c10bbfbc99eccc16c22223146435839584a545a58765a74656167547265664a4542505a4d743842466d646f691a600803125c0a2c10bbfbc99eccc16c22223146435839584a545a58765a74656167547265664a4542505a4d743842466d646f69122c10bb83eda585b36c22223146435839584a545a58765a74656167547265664a4542505a4d743842466d646f691a5e0803125a0a2b10fbdfb5acfd1d222231374a4745764445424569676a6f6f5a62646d746878615364384b6a353242657465122b10fbd792a5c42c222231374a4745764445424569676a6f6f5a62646d746878615364384b6a353242657465"
	index := int64(1)
	env, err := util.GenEnv(blockByte, index)
	assert.Nil(t, err)

	convert := coins.NewConvert("", "bty", []string{})
	records, err := convert.ConvertTx(env, db.SeqTypeAdd)
	assert.Nil(t, err)
	assert.Equal(t, 4, len(records))

	record, ok := records[0].(*transaction.TxRecord)
	assert.True(t, ok)
	assert.Equal(t, db.OpAdd, record.Op.OpType())
	assert.Equal(t, "transaction/transaction/0x531c8d8214e384e314136cf8f70fc6e1dd936887110075d5bd6a966a056953ab", record.Key())
	tx := `{"height_index":285457100001,"height":2854571,"block_time":1564060086,"block_hash":"0xf355d454da413f4c8932a7c8ccc24076e3186a0ec4beb2a7ddd0587e61b2c948","success":true,"index":1,"hash":"0x531c8d8214e384e314136cf8f70fc6e1dd936887110075d5bd6a966a056953ab","from":"1FCX9XJTZXvZteagTrefJEBPZMt8BFmdoi","to":"17JGEvDEBEigjooZbdmthxaSd8Kj52Bete","execer":"coins","amount":500080000000,"fee":100000,"action_name":"transfer","group_count":0,"is_withdraw":false,"options":null,"assets":[{"exec":"coins","symbol":"BTY","amount":500080000000}],"next":"","is_para":false}`
	assert.Equal(t, tx, string(record.Value()))
	//t.Log(string(record.Value()))
	//assert.False(t, ok)
}

func Test_ConvertAll(t *testing.T) {
	blockByte := "0aea071220cb6810299957802da8ebd0e18dc900ba5a3d6746352b42d703f11cf88c3f9d5c1a20bbdb455fd1674c3540b2c3cab944c625716331e74fc0e02f3cd519e363a17d962220e13c5d5f04761e59ffb554730e9bc353c47f8710c89b788b1dde3f33c74d4d3d28ab9dae0130b6d3e6e9053a90050a067469636b657412e403501022df0308d3de83f1011080cab5ee011ac4013145776b4b6439695531704c325a776d524143355272426f71464431614d7251323a3078316435663362393337386264666634346565313761356136363135343965613263623230383032386436633539636139313064336430383636366436333533353a303030303030303030303a323162356138653336366332646330383439663134383937303433333730643338656130613033393236356263323464396438616133646664343238646632663a3135363239363638303937383134343331313922423078643464643230623737373537336239343464613936376162326333613365666535333866326136313638326537353430306264623931623865336232616362622a20c30eb9a29a6b64a325efb6934a296207f80957221612bf73ededb47b4fa586ad3220714788f458028a1de087d7c258787cdb5b1e8a415ec3ac5dfcfaed1e21fae2c83a81011bb60bc2363a1a66d91ce10d6e374951b03f12f282fe7c51db3fd76ae9aee41eaffff651a4f271a52544983eeeab747a65205dbf67a24214d816bb111a4ebdd604d5dab2d232820d3e2b4ecf916e073a53071ed38a530fe2373f6f7630fb76d99725d824061a794176279b3cdbd9cbb070f6ac0a132d8c84e7ec920d89950be8b61a6d0801122103ee1171e51abe4d3dbd8b9a076d601663ad3f3f2f4f98d517d1f0c410a1fdd5b61a4630440220362018642640206432751187a19a090e2018122b05d33b8d2a4b53aca005ee440220418680ce93ee0f151d6813f1e942de1c804351eddfb4da7c9052701ce777ff5020a08d0630ade2bed7c397e9a5603a22313668747663424e53454137665a6841644c4a706844775152514a614870794854703ab6010a05636f696e73120b18010a071080f8dcf8c60e1a6e0801122102dd9744936ea82d4309b47e007456deb4ed4de77cec3ae2b155f86f8c9b503d8d1a473045022100d510ab5e2a989ea7d36382f07fd6e76c880625883ecd7c64891e505901896fbc02200b940f9d1608fca12530a1054b13b60726ba80873900d8d0f6c79a8db723decf20a08d0630adecb69efff4e8e1633a2231374a4745764445424569676a6f6f5a62646d746878615364384b6a35324265746558d3de83f1016220cab08f4999c4a0b43d97a06dfca66739b6d0ebb368777b93a38740e053f369e568ab9dae0112cc0608021a5c080212580a2a10bbb8bcebea0222213145776b4b6439695531704c325a776d524143355272426f71464431614d725132122a109babb6ebea0222213145776b4b6439695531704c325a776d524143355272426f71464431614d7251321af301087112ee010ac4013145776b4b6439695531704c325a776d524143355272426f71464431614d7251323a3078316435663362393337386264666634346565313761356136363135343965613263623230383032386436633539636139313064336430383636366436333533353a303030303030303030303a323162356138653336366332646330383439663134383937303433333730643338656130613033393236356263323464396438616133646664343238646632663a313536323936363830393738313434333131391002180122213145776b4b6439695531704c325a776d524143355272426f71464431614d7251321a620805125e0a2d10cdff80db98fdb8432222313668747663424e53454137665a6841644c4a706844775152514a61487079485470122d10cdc9b6c99afdb8432222313668747663424e53454137665a6841644c4a706844775152514a614870794854701a93010808128e010a22313668747663424e53454137665a6841644c4a706844775152514a61487079485470123310808a87d0251880b482a9edeb9d04222231457852524c6f4a5861384c7a58644e786e4a76426b564e5a7056773351574d69341a3310808a87d0251880feb797efeb9d04222231457852524c6f4a5861384c7a58644e786e4a76426b564e5a7056773351574d69341a620805125e0a2d10cdc9b6c99afdb8432222313668747663424e53454137665a6841644c4a706844775152514a61487079485470122d10cd8fbdd89bfdb8432222313668747663424e53454137665a6841644c4a706844775152514a614870794854701a950108081290010a22313668747663424e53454137665a6841644c4a706844775152514a6148707948547012341080c0958fc7d6e2041880bac89efa7f2222314a6d46614136756e724346594557504752693775755859314b7468544a784a45501a341080c0958fc7d6e204188080cfadfb7f2222314a6d46614136756e724346594557504752693775755859314b7468544a784a455012a60208021a600802125c0a2c10db88d09eccc16c22223146435839584a545a58765a74656167547265664a4542505a4d743842466d646f69122c10bbfbc99eccc16c22223146435839584a545a58765a74656167547265664a4542505a4d743842466d646f691a600803125c0a2c10bbfbc99eccc16c22223146435839584a545a58765a74656167547265664a4542505a4d743842466d646f69122c10bb83eda585b36c22223146435839584a545a58765a74656167547265664a4542505a4d743842466d646f691a5e0803125a0a2b10fbdfb5acfd1d222231374a4745764445424569676a6f6f5a62646d746878615364384b6a353242657465122b10fbd792a5c42c222231374a4745764445424569676a6f6f5a62646d746878615364384b6a353242657465"
	index := int64(1)
	env, err := util.GenEnv(blockByte, index)
	assert.Nil(t, err)

	convert := coins.NewConvert("", "bty", []string{})
	records, err := convert.ConvertTx(env, db.SeqTypeAdd)
	assert.Nil(t, err)
	assert.Equal(t, 4, len(records))
}

func Test_ConvertAccount(t *testing.T) {
	blockByte := "0aea071220cb6810299957802da8ebd0e18dc900ba5a3d6746352b42d703f11cf88c3f9d5c1a20bbdb455fd1674c3540b2c3cab944c625716331e74fc0e02f3cd519e363a17d962220e13c5d5f04761e59ffb554730e9bc353c47f8710c89b788b1dde3f33c74d4d3d28ab9dae0130b6d3e6e9053a90050a067469636b657412e403501022df0308d3de83f1011080cab5ee011ac4013145776b4b6439695531704c325a776d524143355272426f71464431614d7251323a3078316435663362393337386264666634346565313761356136363135343965613263623230383032386436633539636139313064336430383636366436333533353a303030303030303030303a323162356138653336366332646330383439663134383937303433333730643338656130613033393236356263323464396438616133646664343238646632663a3135363239363638303937383134343331313922423078643464643230623737373537336239343464613936376162326333613365666535333866326136313638326537353430306264623931623865336232616362622a20c30eb9a29a6b64a325efb6934a296207f80957221612bf73ededb47b4fa586ad3220714788f458028a1de087d7c258787cdb5b1e8a415ec3ac5dfcfaed1e21fae2c83a81011bb60bc2363a1a66d91ce10d6e374951b03f12f282fe7c51db3fd76ae9aee41eaffff651a4f271a52544983eeeab747a65205dbf67a24214d816bb111a4ebdd604d5dab2d232820d3e2b4ecf916e073a53071ed38a530fe2373f6f7630fb76d99725d824061a794176279b3cdbd9cbb070f6ac0a132d8c84e7ec920d89950be8b61a6d0801122103ee1171e51abe4d3dbd8b9a076d601663ad3f3f2f4f98d517d1f0c410a1fdd5b61a4630440220362018642640206432751187a19a090e2018122b05d33b8d2a4b53aca005ee440220418680ce93ee0f151d6813f1e942de1c804351eddfb4da7c9052701ce777ff5020a08d0630ade2bed7c397e9a5603a22313668747663424e53454137665a6841644c4a706844775152514a614870794854703ab6010a05636f696e73120b18010a071080f8dcf8c60e1a6e0801122102dd9744936ea82d4309b47e007456deb4ed4de77cec3ae2b155f86f8c9b503d8d1a473045022100d510ab5e2a989ea7d36382f07fd6e76c880625883ecd7c64891e505901896fbc02200b940f9d1608fca12530a1054b13b60726ba80873900d8d0f6c79a8db723decf20a08d0630adecb69efff4e8e1633a2231374a4745764445424569676a6f6f5a62646d746878615364384b6a35324265746558d3de83f1016220cab08f4999c4a0b43d97a06dfca66739b6d0ebb368777b93a38740e053f369e568ab9dae0112cc0608021a5c080212580a2a10bbb8bcebea0222213145776b4b6439695531704c325a776d524143355272426f71464431614d725132122a109babb6ebea0222213145776b4b6439695531704c325a776d524143355272426f71464431614d7251321af301087112ee010ac4013145776b4b6439695531704c325a776d524143355272426f71464431614d7251323a3078316435663362393337386264666634346565313761356136363135343965613263623230383032386436633539636139313064336430383636366436333533353a303030303030303030303a323162356138653336366332646330383439663134383937303433333730643338656130613033393236356263323464396438616133646664343238646632663a313536323936363830393738313434333131391002180122213145776b4b6439695531704c325a776d524143355272426f71464431614d7251321a620805125e0a2d10cdff80db98fdb8432222313668747663424e53454137665a6841644c4a706844775152514a61487079485470122d10cdc9b6c99afdb8432222313668747663424e53454137665a6841644c4a706844775152514a614870794854701a93010808128e010a22313668747663424e53454137665a6841644c4a706844775152514a61487079485470123310808a87d0251880b482a9edeb9d04222231457852524c6f4a5861384c7a58644e786e4a76426b564e5a7056773351574d69341a3310808a87d0251880feb797efeb9d04222231457852524c6f4a5861384c7a58644e786e4a76426b564e5a7056773351574d69341a620805125e0a2d10cdc9b6c99afdb8432222313668747663424e53454137665a6841644c4a706844775152514a61487079485470122d10cd8fbdd89bfdb8432222313668747663424e53454137665a6841644c4a706844775152514a614870794854701a950108081290010a22313668747663424e53454137665a6841644c4a706844775152514a6148707948547012341080c0958fc7d6e2041880bac89efa7f2222314a6d46614136756e724346594557504752693775755859314b7468544a784a45501a341080c0958fc7d6e204188080cfadfb7f2222314a6d46614136756e724346594557504752693775755859314b7468544a784a455012a60208021a600802125c0a2c10db88d09eccc16c22223146435839584a545a58765a74656167547265664a4542505a4d743842466d646f69122c10bbfbc99eccc16c22223146435839584a545a58765a74656167547265664a4542505a4d743842466d646f691a600803125c0a2c10bbfbc99eccc16c22223146435839584a545a58765a74656167547265664a4542505a4d743842466d646f69122c10bb83eda585b36c22223146435839584a545a58765a74656167547265664a4542505a4d743842466d646f691a5e0803125a0a2b10fbdfb5acfd1d222231374a4745764445424569676a6f6f5a62646d746878615364384b6a353242657465122b10fbd792a5c42c222231374a4745764445424569676a6f6f5a62646d746878615364384b6a353242657465"
	index := int64(1)
	env, err := util.GenEnv(blockByte, index)
	assert.Nil(t, err)

	convert := coins.NewConvert("", "bty", []string{account.RAccountX})
	records, err := convert.ConvertTx(env, db.SeqTypeAdd)
	assert.Nil(t, err)
	assert.Equal(t, 4, len(records))

	acc1 := `{"address":"1FCX9XJTZXvZteagTrefJEBPZMt8BFmdoi","exec":"","frozen":0,"balance":477242871414203,"total":477242871414203,"type":"personage","height_index":285457100001,"asset_symbol":"bty","asset_exec":"coins"}`
	acc2 := `{"address":"1FCX9XJTZXvZteagTrefJEBPZMt8BFmdoi","exec":"","frozen":0,"balance":476742791414203,"total":476742791414203,"type":"personage","height_index":285457100001,"asset_symbol":"bty","asset_exec":"coins"}`
	acc3 := `{"address":"17JGEvDEBEigjooZbdmthxaSd8Kj52Bete","exec":"","frozen":0,"balance":1530159999995,"total":1530159999995,"type":"personage","height_index":285457100001,"asset_symbol":"bty","asset_exec":"coins"}`

	record1, ok := records[1].(*account.Record)
	assert.True(t, ok)
	record2, ok := records[2].(*account.Record)
	assert.True(t, ok)
	record3, ok := records[3].(*account.Record)
	assert.True(t, ok)
	assert.Equal(t, db.OpAdd, record1.Op.OpType())
	assert.Equal(t, "account/account/1FCX9XJTZXvZteagTrefJEBPZMt8BFmdoi-coins-coins:bty", record1.Key())
	assert.Equal(t, acc1, string(record1.Value()))
	assert.Equal(t, acc2, string(record2.Value()))
	assert.Equal(t, acc3, string(record3.Value()))
	for _, r := range records {
		t.Log(string(r.Value()))
	}
}

func Test_ConvertWithdraw(t *testing.T) {
	//account.Init([]string{"16htvcBNSEA7fZhAdLJphDwQRQJaHpyHTp"})
	account.AddExecAddress("16htvcBNSEA7fZhAdLJphDwQRQJaHpyHTp")
	blockByte := "0aa8081220b3f58442c1e2c3e213204dc4650b01d40d94703fa8aacfeda2fcdbe37322d89d1a2040bbe1352380c26091cccf5067880e2eaa24be91893362adf304bef36f8d29c222204960e8599aebe4eac50cbb2f6efc63f8f010879924942c9d51a357b2cfcef3e828c9fbb40130cfe088ea053a91050a067469636b657412e503501022e003088bd48df1011080cab5ee011ac501314d6f456e434468585a36517635664e4447596f57364d56454254424b36324850323a3078383662616461393330633933666134313436353737323962393666633237353935623137333336363839323936313831353764336539306163363037623264383a303030303030303030323a643132613462316336633035376266623538323732386137376233353138666333383964386533646234643566616663646135656161633261666563646363333a3135363431353836383233313936383331333922423078343930653132386563393435373734646562343039616464643034393432653461336138396632613263643863643964396631613333363466666666313534382a20908df045fab5bfae21e497c6950339540a50e03951a10f2d42087a40379f51a53220f3430a91d54c4d357c4c7956ddbdf41212471bfb71ef60c4fe4229100c15f2283a8101a5dbaba6c7e458923e703632b00f82018aebb40b6b8187f54847746bc9e048813660db309c66e091b39d953bf38803498a13d5757faaf30d8a5842fcf865f3f6049d5f15ca916c0d691c660bc81e14adda18f7c3508ef98d4c951a02e4c104195dad147fac2d225729cf1d153b9a24e13d1e274fb08f7bc9049c07cf1c237433581a6d080112210372a0a28100901108ced01ea8cd4271652bdb1ecf0bc5bbc33d0cf8a39f9424a51a46304402207d31ca070d3e88460ceb2012865dd4c68dd60027b7c065ee15f294c927c9374f02200462a341d3153d7869ef7d1f13a3651c5eb028a569daf95aea5bfd60682433c220a08d0630f8e8ab87dbb7c783683a22313668747663424e53454137665a6841644c4a706844775152514a614870794854703af3010a05636f696e7312431803223f1080cab5ee011a136175746f6d696e65722d3e77697468647261772a22313668747663424e53454137665a6841644c4a706844775152514a614870794854701a6d080112210215c81909174d56828d7305d50b0445c1c3ffbdfa474af7c23d1444b88d8853fd1a46304402204be1d64f2cc41f1c911d135210c9a012fe9c787beff9c6ff6ea0e3818ae5b31402203389af204ad1ad0a549d188fe192cbfa23ab88fbf48bd381ef56f8ecaae70d7c20c3ca0828bfe188ea0530bdafa0e3879bb8db763a22313668747663424e53454137665a6841644c4a706844775152514a61487079485470588bd48df10162204d942c79a16bd681e8521eab4a6ec62b71c2e83978b97a9c955fbd256324d17468c9fbb40112d20608021a5e0802125a0a2b10e8a6ada1ba012222314d6f456e434468585a36517635664e4447596f57364d56454254424b3632485032122b10c899a7a1ba012222314d6f456e434468585a36517635664e4447596f57364d56454254424b36324850321af501087112f0010ac501314d6f456e434468585a36517635664e4447596f57364d56454254424b36324850323a3078383662616461393330633933666134313436353737323962393666633237353935623137333336363839323936313831353764336539306163363037623264383a303030303030303030323a643132613462316336633035376266623538323732386137376233353138666333383964386533646234643566616663646135656161633261666563646363333a31353634313538363832333139363833313339100218012222314d6f456e434468585a36517635664e4447596f57364d56454254424b36324850321a620805125e0a2d10bbf2d1b2a1e5da432222313668747663424e53454137665a6841644c4a706844775152514a61487079485470122d10bbbc87a1a3e5da432222313668747663424e53454137665a6841644c4a706844775152514a614870794854701a950108081290010a22313668747663424e53454137665a6841644c4a706844775152514a6148707948547012341080c4caf69202188084d6c088d589062222314247395a6f4b7467553562684b4c706373726e635a3678647a4643676a725a75641a341080c4caf692021880ce8baf8ad589062222314247395a6f4b7467553562684b4c706373726e635a3678647a4643676a725a75641a620805125e0a2d10bbbc87a1a3e5da432222313668747663424e53454137665a6841644c4a706844775152514a61487079485470122d10bb828eb0a4e5da432222313668747663424e53454137665a6841644c4a706844775152514a614870794854701a950108081290010a22313668747663424e53454137665a6841644c4a706844775152514a6148707948547012341080e8a383dc9aea041880c6b2f9b47f2222314a6d46614136756e724346594557504752693775755859314b7468544a784a45501a341080e8a383dc9aea0418808cb988b67f2222314a6d46614136756e724346594557504752693775755859314b7468544a784a455012ba0308021a5e0802125a0a2b10e984a4b597072222314e5051396375356f514a5170584773655756433150454b5156646d62376f317962122b10a6ba9bb597072222314e5051396375356f514a5170584773655756433150454b5156646d62376f3179621a91010807128c010a22313668747663424e53454137665a6841644c4a706844775152514a6148707948547012321080f28ba80918808ae796b7dd052222314e5051396375356f514a5170584773655756433150454b5156646d62376f3179621a321080a8d6b90718808ae796b7dd052222314e5051396375356f514a5170584773655756433150454b5156646d62376f3179621a620803125e0a2d10bb828eb0a4e5da432222313668747663424e53454137665a6841644c4a706844775152514a61487079485470122d10bbb8d8c1a2e5da432222313668747663424e53454137665a6841644c4a706844775152514a614870794854701a5e0803125a0a2b10a6ba9bb597072222314e5051396375356f514a5170584773655756433150454b5156646d62376f317962122b10a684d1a399072222314e5051396375356f514a5170584773655756433150454b5156646d62376f317962"
	index := int64(1)
	env, err := util.GenEnv(blockByte, index)

	assert.Nil(t, err)

	convert := coins.NewConvert("", "bty", []string{transaction.RTransactionX, account.RAccountX})
	records, err := convert.ConvertTx(env, db.SeqTypeAdd)
	assert.Nil(t, err)
	assert.Equal(t, 5, len(records))

	txStr := `{"height_index":296493700001,"height":2964937,"block_time":1564618831,"block_hash":"0xb1e7b23b5a41613147b1ece97511d5602ef75385f39444f7b75c3ba1ba31f9f1","success":true,"index":1,"hash":"0x86cd2683d6733c5df0f215ef629170ddc0b14edaa7f5a32e5d40418ceb1b3b6c","from":"1NPQ9cu5oQJQpXGseWVC1PEKQVdmb7o1yb","to":"16htvcBNSEA7fZhAdLJphDwQRQJaHpyHTp","execer":"coins","amount":500000000,"fee":140611,"action_name":"withdraw","group_count":0,"is_withdraw":true,"options":null,"assets":[{"exec":"coins","symbol":"BTY","amount":500000000}],"next":"","is_para":false}`
	txKey := `transaction/transaction/0x86cd2683d6733c5df0f215ef629170ddc0b14edaa7f5a32e5d40418ceb1b3b6c`
	acc1 := `{"address":"1NPQ9cu5oQJQpXGseWVC1PEKQVdmb7o1yb","exec":"","frozen":0,"balance":246803782950,"total":246803782950,"type":"personage","height_index":296493700001,"asset_symbol":"bty","asset_exec":"coins"}`
	acc2 := `{"address":"1NPQ9cu5oQJQpXGseWVC1PEKQVdmb7o1yb","exec":"16htvcBNSEA7fZhAdLJphDwQRQJaHpyHTp","frozen":25200500000000,"balance":2000000000,"total":25202500000000,"type":"contractInternal","height_index":296493700001,"asset_symbol":"bty","asset_exec":"coins"}`
	acc3 := `{"address":"16htvcBNSEA7fZhAdLJphDwQRQJaHpyHTp","exec":"","frozen":0,"balance":38116950663371835,"total":38116950663371835,"type":"contract","height_index":296493700001,"asset_symbol":"bty","asset_exec":"coins"}`
	acc4 := `{"address":"1NPQ9cu5oQJQpXGseWVC1PEKQVdmb7o1yb","exec":"","frozen":0,"balance":247303782950,"total":247303782950,"type":"personage","height_index":296493700001,"asset_symbol":"bty","asset_exec":"coins"}`
	tx, ok := records[0].(*transaction.TxRecord)
	assert.True(t, ok)
	assert.Equal(t, txStr, string(tx.Value()))
	assert.Equal(t, true, tx.Tx.IsWithdraw)
	assert.Equal(t, txKey, tx.Key())

	feeAcc, ok := records[1].(*account.Record)
	assert.True(t, ok)
	internal, ok := records[2].(*account.Record)
	assert.True(t, ok)
	record3, ok := records[3].(*account.Record)
	assert.True(t, ok)
	record4, ok := records[4].(*account.Record)
	assert.True(t, ok)
	assert.Equal(t, db.OpAdd, internal.Op.OpType())

	assert.Equal(t, acc1, string(feeAcc.Value()))
	assert.Equal(t, acc2, string(internal.Value()))
	assert.Equal(t, "account/account/1NPQ9cu5oQJQpXGseWVC1PEKQVdmb7o1yb-16htvcBNSEA7fZhAdLJphDwQRQJaHpyHTp-coins:bty", internal.Key())
	assert.Equal(t, account.AccountContractInternal, internal.Acc.Type)
	assert.Equal(t, acc3, string(record3.Value()))
	assert.Equal(t, acc4, string(record4.Value()))
	t.Log(record4)
	for _, r := range records {
		t.Log(string(r.Value()))
	}
}

func Test_ConvertTransferToExec(t *testing.T) {
	//account.Init([]string{"16htvcBNSEA7fZhAdLJphDwQRQJaHpyHTp"})
	account.AddExecAddress("16htvcBNSEA7fZhAdLJphDwQRQJaHpyHTp")

	blockByte := "0ac1101220e259ac6f5af1037ceb5bc5742e3a5f85374defcbb3a966c2ed2e482e141a7b071a20efb446532127b0e45edcc143caaf94fb00c28d8a2e4299f7c1707675ad5110e02220fb3ab0f98434a780c66696f16ffaf1ea773ebeda4c24856489c58bdb33a16ccb2881b71d30d9ecb3db053af4020a067469636b657412c701501022c201088c95d6f1011080a4a7da061a70314d6f456e434468585a36517635664e4447596f57364d56454254424b36324850323a3078656465303539653237316135383335353065623661343532656139306134633734633663666562316634316231396138326637363861323862396363353438653a3030303030303030303022423078656631613661386663623865323735353761326362333835353437343230333732336663616130383733346538363432336131646633616565643164333463661a6e080112210372a0a28100901108ced01ea8cd4271652bdb1ecf0bc5bbc33d0cf8a39f9424a51a473045022100d76604a6c2a0543f24c4d2c79a7c02d33ae5da9dd7cbae1a6b26070bf8597d2b02203ca41967f05441ffb0ec5c1c0f480d19f2152dbb0cf4e1a25367a7b645e3b7e420a08d0630ffb78bfb97a5c2aa603a22313668747663424e53454137665a6841644c4a706844775152514a614870794854703ad4010a05636f696e731223180a2a1f1080808d93f5d7711a0d636f696e732d3e7469636b657422067469636b65741a6e080112210250845719edb0b037a2e7ac9048e7f890ce1e90ec598d9bfe12012e39d9330d4e1a473045022100c112d01136bcb55ea70c49720fc9d906966b26d1b25405adce16a3807189a6ba022012f1f19a97ae824cacefdc5e5892ee893326a3cc851d4e5c8da36d249438dd7520a08d0628f788b4db05308e92c7dc83a1b5e9303a22313668747663424e53454137665a6841644c4a706844775152514a614870794854703afe010a067469636b6574124c50112a480a22313841697559726a32554b554265464b724377356d4c43433978797957786975347a12223145636258354c4a3366313636394c5a774b44666477353563564b48314b333371561a6e0801122103de03c33edc57859fc174a8ad50ae83ce5d7e6f3e80e82cdd981419910210d9981a4730450221009351bb9ed063dac18caf93e51a9f64aa2e460656ea10d5903f03d773cedccdc202205a629cb39c20ba6ab9d5353f555d482bc840fd6116845dcc11a2fa58f997b34b20c09a0c28ae89b4db0530aa84dd909de7cfa21c3a22313668747663424e53454137665a6841644c4a706844775152514a614870794854703aa8020a067469636b65741276500d1a720a703133536e6570784c3552454c6e4c7778475457466b4d4a4d674d4a714a68503446563a3078323863363331653037336634663065666439643633303766626265613463396164356430633739633733343565633435323065373130393934386435346131643a303030303030303030301a6e0801122102142a94a3c30bc120b55f63d85768520ee68fba95cdb5dcc7cec5a8e377b88a031a47304502210089ba08daad7eb42563c60794a1f4b1bf50907c234007fdd5077f5c67d73284e502207dea62f500c36271c51aef2385dcdb201b6011aa225c276921ce0211002fcabd20a08d0628c8edb3db0530cdf58af2e9b5f7d2533a22313668747663424e53454137665a6841644c4a706844775152514a614870794854703aa7020a067469636b65741276500d1a720a7031395150434463725050506e5944414b654d50436142466e72613576646a63556f523a3078633636666635383638623333363731323537373266383636376563303134616539393361643530646464393638653765346336343137663738363131333739303a303030303030303030301a6d0801122103f70678ad6e6682c27d1bf59e04eb074a37f04d49555d299e766b884a517dbec91a463044022006e33fb88e74eb685a6241687a51c5f613c6bce1df282f1dcc9a7173375cd831022079011d115b6b426e09e93968da3be945fe63ddb11ea6652b9bbe0ec7f7e0b3e120a08d0628c8edb3db0530f6dcf88b87c6f3df7a3a22313668747663424e53454137665a6841644c4a706844775152514a614870794854703aa7020a067469636b65741276500d1a720a7031504153617a62647a316f6637683956316444784e4c6863396e6374664d724e64333a3078383739626635353934343137613239383839323966343836663833663632663731636266336230646132623962376530656638393561366231373539316233363a303030303030303030301a6d080112210344801efdc91c0e3f72005d00ecb05cab4f2a3daca2a48b508e97b66b6ee1198d1a46304402207e629db5da45aaa2287508b7fd99ab99b07993c48673c7d859b4153e218256fc022029c01d2949a601e9f692aacdb07a6d6f3c1cfde9e80d5d733359e235809ee5f820a08d0628cbedb3db0530d684bc9eebf9fcd0283a22313668747663424e53454137665a6841644c4a706844775152514a614870794854703ad4010a05636f696e731223180a2a1f1080e0e68ed0987e1a0d636f696e732d3e7469636b657422067469636b65741a6e0801122103de03c33edc57859fc174a8ad50ae83ce5d7e6f3e80e82cdd981419910210d9981a47304502210092bdf4ce186b570ec788fe524e4dbb5360b94420a1e03ca67c2b73c367b3e5c202206eccc0f7062f3ed8eb9da9ab650581b13174903d3b4a13273db1d4efa468a1cc20a08d0628ae89b4db0530f8fdb5f7a1b7d1965c3a22313668747663424e53454137665a6841644c4a706844775152514a61487079485470588c95d6f10162205ae2774f5e431d53e49019dea270173af29fafd4940ef064166d114b28db1a766881b71d12f80508021a5e0802125a0a2b10c0fdc989e11c2222314d6f456e434468585a36517635664e4447596f57364d56454254424b3632485032122b10a0f0c389e11c2222314d6f456e434468585a36517635664e4447596f57364d56454254424b36324850321a9f010871129a010a70314d6f456e434468585a36517635664e4447596f57364d56454254424b36324850323a3078656465303539653237316135383335353065623661343532656139306134633734633663666562316634316231396138326637363861323862396363353438653a30303030303030303030100218012222314d6f456e434468585a36517635664e4447596f57364d56454254424b36324850321a620805125e0a2d10c389c0fffdd7da342222313668747663424e53454137665a6841644c4a706844775152514a61487079485470122d10c3ade7d984d8da342222313668747663424e53454137665a6841644c4a706844775152514a614870794854701a93010808128e010a22313668747663424e53454137665a6841644c4a706844775152514a6148707948547012331080f4f6905d1880e4bdbda88ebf052222314247395a6f4b7467553562684b4c706373726e635a3678647a4643676a725a75641a331080f4f6905d188088e597af8ebf052222314247395a6f4b7467553562684b4c706373726e635a3678647a4643676a725a75641a620805125e0a2d10c3ade7d984d8da342222313668747663424e53454137665a6841644c4a706844775152514a61487079485470122d10c3c5819689d8da342222313668747663424e53454137665a6841644c4a706844775152514a614870794854701a93010808128e010a22313668747663424e53454137665a6841644c4a706844775152514a6148707948547012331080d083bebaff7d1880b0f8d9b53c2222314a6d46614136756e724346594557504752693775755859314b7468544a784a45501a331080d083bebaff7d1880c89296ba3c2222314a6d46614136756e724346594557504752693775755859314b7468544a784a455012a50308021a600802125c0a2c10c0e9aff2f5d77122223147334852534c50414b764b63545957374b4e68615766746763686a394869776e56122c10a0dca9f2f5d77122223147334852534c50414b764b63545957374b4e68615766746763686a394869776e561a5d080312590a2c10a0dca9f2f5d77122223147334852534c50414b764b63545957374b4e68615766746763686a394869776e56122910a0dc9c5f22223147334852534c50414b764b63545957374b4e68615766746763686a394869776e561a620803125e0a2d10c3c5819689d8da342222313668747663424e53454137665a6841644c4a706844775152514a61487079485470122d10c3c58ea9feafcc352222313668747663424e53454137665a6841644c4a706844775152514a614870794854701a7c080812780a22313668747663424e53454137665a6841644c4a706844775152514a61487079485470122422223147334852534c50414b764b63545957374b4e68615766746763686a394869776e561a2c1080808d93f5d77122223147334852534c50414b764b63545957374b4e68615766746763686a394869776e5612b20108021a600802125c0a2c108080fbb3ddb57e22223145636258354c4a3366313636394c5a774b44666477353563564b48314b33337156122c10c0e5eeb3ddb57e22223145636258354c4a3366313636394c5a774b44666477353563564b48314b333371561a4c087212481222313841697559726a32554b554265464b724377356d4c43433978797957786975347a1a223145636258354c4a3366313636394c5a774b44666477353563564b48314b3333715612b00408021a5c080212580a2a10c0c39bdc4422223133536e6570784c3552454c6e4c7778475457466b4d4a4d674d4a714a6850344656122a10a0b695dc4422223133536e6570784c3552454c6e4c7778475457466b4d4a4d674d4a714a68503446561a9f010870129a010a703133536e6570784c3552454c6e4c7778475457466b4d4a4d674d4a714a68503446563a3078323863363331653037336634663065666439643633303766626265613463396164356430633739633733343565633435323065373130393934386435346131643a303030303030303030301003180222223133536e6570784c3552454c6e4c7778475457466b4d4a4d674d4a714a68503446561a9501080a1290010a22313668747663424e53454137665a6841644c4a706844775152514a61487079485470123410808c8ad3b5051880d0e3a38388cb0122223142414b6758416367547a464634797348796848777939465576506a6e7473486a631a341080d0c5d2c92218808ca8a4efeaca0122223142414b6758416367547a464634797348796848777939465576506a6e7473486a631a9301080a128e010a22313668747663424e53454137665a6841644c4a706844775152514a6148707948547012331080d083bebaff7d1880c89296ba3c2222314a6d46614136756e724346594557504752693775755859314b7468544a784a45501a331080e89dfabeff7d1880b0f8d9b53c2222314a6d46614136756e724346594557504752693775755859314b7468544a784a455012ae0408021a5c080212580a2a1080cad6f425222231395150434463725050506e5944414b654d50436142466e72613576646a63556f52122a10e0bcd0f425222231395150434463725050506e5944414b654d50436142466e72613576646a63556f521a9f010870129a010a7031395150434463725050506e5944414b654d50436142466e72613576646a63556f523a3078633636666635383638623333363731323537373266383636376563303134616539393361643530646464393638653765346336343137663738363131333739303a3030303030303030303010031802222231395150434463725050506e5944414b654d50436142466e72613576646a63556f521a9301080a128e010a22313668747663424e53454137665a6841644c4a706844775152514a614870794854701233108090ffb8c5061880c0f3bfd982712222313651674d565a4d336f4245374e4c77645232314c794e58685367524354444d4d731a331080d4bab8d9231880fcb7c0c5e5702222313651674d565a4d336f4245374e4c77645232314c794e58685367524354444d4d731a9301080a128e010a22313668747663424e53454137665a6841644c4a706844775152514a6148707948547012331080e89dfabeff7d1880b0f8d9b53c2222314a6d46614136756e724346594557504752693775755859314b7468544a784a45501a33108080b8b6c3ff7d188098de9db13c2222314a6d46614136756e724346594557504752693775755859314b7468544a784a455012ab0408021a5a080212560a2910c0a9bd6b222231504153617a62647a316f6637683956316444784e4c6863396e6374664d724e6433122910a09cb76b222231504153617a62647a316f6637683956316444784e4c6863396e6374664d724e64331a9f010870129a010a7031504153617a62647a316f6637683956316444784e4c6863396e6374664d724e64333a3078383739626635353934343137613239383839323966343836663833663632663731636266336230646132623962376530656638393561366231373539316233363a3030303030303030303010031802222231504153617a62647a316f6637683956316444784e4c6863396e6374664d724e64331a9201080a128d010a22313668747663424e53454137665a6841644c4a706844775152514a614870794854701232109e86a8bb251880ccebfda8a520222231504153617a62647a316f6637683956316444784e4c6863396e6374664d724e64331a33109ecae3bab91d188088b0fe948820222231504153617a62647a316f6637683956316444784e4c6863396e6374664d724e64331a9301080a128e010a22313668747663424e53454137665a6841644c4a706844775152514a614870794854701233108080b8b6c3ff7d188098de9db13c2222314a6d46614136756e724346594557504752693775755859314b7468544a784a45501a33108098d2f2c7ff7d188080c4e1ac3c2222314a6d46614136756e724346594557504752693775755859314b7468544a784a455012a70308021a600802125c0a2c10c0e5eeb3ddb57e22223145636258354c4a3366313636394c5a774b44666477353563564b48314b33337156122c10a0d8e8b3ddb57e22223145636258354c4a3366313636394c5a774b44666477353563564b48314b333371561a5f0803125b0a2c10a0d8e8b3ddb57e22223145636258354c4a3366313636394c5a774b44666477353563564b48314b33337156122b10a0f881a58d1d22223145636258354c4a3366313636394c5a774b44666477353563564b48314b333371561a620803125e0a2d10c3c58ea9feafcc352222313668747663424e53454137665a6841644c4a706844775152514a61487079485470122d10c3a5f5b7cec8ca362222313668747663424e53454137665a6841644c4a706844775152514a614870794854701a7c080812780a22313668747663424e53454137665a6841644c4a706844775152514a61487079485470122422223145636258354c4a3366313636394c5a774b44666477353563564b48314b333371561a2c1080e0e68ed0987e22223145636258354c4a3366313636394c5a774b44666477353563564b48314b33337156"
	index := int64(1)
	env, err := util.GenEnv(blockByte, index)
	assert.Nil(t, err)

	convert := coins.NewConvert("", "bty", []string{transaction.RTransactionX, account.RAccountX})
	records, err := convert.ConvertTx(env, db.SeqTypeAdd)
	assert.Nil(t, err)
	assert.Equal(t, 5, len(records))

	txKey := `transaction/transaction/0xdbf2ca3a9e65dec47992d9f0f4113a4f7fdfd52d460fd3a20725d47029bf91a6`
	acc1 := `{"address":"1G3HRSLPAKvKcTYW7KNhaWftgchj9HiwnV","exec":"","frozen":0,"balance":500000199700000,"total":500000199700000,"type":"personage","height_index":48217700001,"asset_symbol":"bty","asset_exec":"coins"}`
	acc2 := `{"address":"1G3HRSLPAKvKcTYW7KNhaWftgchj9HiwnV","exec":"","frozen":0,"balance":199700000,"total":199700000,"type":"personage","height_index":48217700001,"asset_symbol":"bty","asset_exec":"coins"}`
	acc3 := `{"address":"16htvcBNSEA7fZhAdLJphDwQRQJaHpyHTp","exec":"","frozen":0,"balance":30172247882965699,"total":30172247882965699,"type":"contract","height_index":48217700001,"asset_symbol":"bty","asset_exec":"coins"}`
	acc4 := `{"address":"1G3HRSLPAKvKcTYW7KNhaWftgchj9HiwnV","exec":"16htvcBNSEA7fZhAdLJphDwQRQJaHpyHTp","frozen":0,"balance":500000000000000,"total":500000000000000,"type":"contractInternal","height_index":48217700001,"asset_symbol":"bty","asset_exec":"coins"}`

	tx, ok := records[0].(*transaction.TxRecord)
	assert.True(t, ok)
	assert.Equal(t, false, tx.Tx.IsWithdraw)
	assert.Equal(t, txKey, tx.Key())

	feeAcc, ok := records[1].(*account.Record)
	assert.True(t, ok)
	record2, ok := records[2].(*account.Record)
	assert.True(t, ok)
	record3, ok := records[3].(*account.Record)
	assert.True(t, ok)
	record4, ok := records[4].(*account.Record)
	assert.True(t, ok)
	assert.Equal(t, db.OpAdd, record2.Op.OpType())

	assert.Equal(t, acc1, string(feeAcc.Value()))
	assert.Equal(t, acc2, string(record2.Value()))
	assert.Equal(t, "account/account/1G3HRSLPAKvKcTYW7KNhaWftgchj9HiwnV-coins-coins:bty", record2.Key())
	assert.Equal(t, account.AccountPersonage, record2.Acc.Type)
	assert.Equal(t, acc3, string(record3.Value()))
	assert.Equal(t, account.AccountContract, record3.Acc.Type)
	assert.Equal(t, acc4, string(record4.Value()))
	assert.Equal(t, account.AccountContractInternal, record4.Acc.Type)
	t.Log(record4)
	for _, r := range records {
		t.Log(string(r.Value()))
	}
}
