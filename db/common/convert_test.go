package common_test

import (
	"testing"

	"github.com/33cn/externaldb/db"
	"github.com/33cn/externaldb/db/common"
	"github.com/33cn/externaldb/db/transaction"
	"github.com/33cn/externaldb/util"
	"github.com/stretchr/testify/assert"
)

func Test_Convert(t *testing.T) {
	blockByte := "0ad403122027c29c662be54757f7a6e941db7595433cf88643833b208643a495635ac403651a2027851fb51f63b74a12f996697864b13fabd1b54384ec8a2fd97d67c329f55e822220ce6ad76964653ad06ee64694e7d85c137d0166ca9327a33b6815dc5ea951a30628a80130e0def4d7053ab7020a067469636b6574128b01501022860108ffff83f8011080a4a7da061a70314d346e73316547486448616b33534e6332555451423735766e58794a51643931733a3078663564396135646431373937333964613863666335623239366265363635656464363565376264316131353537316464313432336666346131346134316630373a3030303030303031303322066d6f646966791a6d08011221024eb415515013b42990c0454db7c5e8ff342dda947e7e4adbf310ee999557bf401a46304402207d891157a8b7ede17ded45498d3b2d51218c1f10a2153a082dedbed8e3d74f1f02201c369a0a3cc871bb2182225afc5985951d81e169a641d1e87bee328a4e48462020a08d063092a2ece38597c6e00a3a22313668747663424e53454137665a6841644c4a706844775152514a6148707948547058ffff83f80162209a918b04c798d1671166eb9fff822970637b48a9d6d24aff284db2f95fdde49e68a80112f80508021a5e0802125a0a2b1080d987a38d1d2222314d346e73316547486448616b33534e6332555451423735766e58794a5164393173122b10e0cb81a38d1d2222314d346e73316547486448616b33534e6332555451423735766e58794a51643931731a9f010871129a010a70314d346e73316547486448616b33534e6332555451423735766e58794a51643931733a3078663564396135646431373937333964613863666335623239366265363635656464363565376264316131353537316464313432336666346131346134316630373a30303030303030313033100218012222314d346e73316547486448616b33534e6332555451423735766e58794a51643931731a620805125e0a2d1080c4d6b4b7aeaf382222313668747663424e53454137665a6841644c4a706844775152514a61487079485470122d1080e8fd8ebeaeaf382222313668747663424e53454137665a6841644c4a706844775152514a614870794854701a970108081292010a22313668747663424e53454137665a6841644c4a706844775152514a6148707948547012351080f8f9efd7ea06188098dab5d8a6a3052222314c7736514c53684b56624b4d3651764d6143517754683555686d793436343443471a351080f8f9efd7ea061880bc8190dfa6a3052222314c7736514c53684b56624b4d3651764d6143517754683555686d793436343443471a620805125e0a2d1080e8fd8ebeaeaf382222313668747663424e53454137665a6841644c4a706844775152514a61487079485470122d10808098cbc2aeaf382222313668747663424e53454137665a6841644c4a706844775152514a614870794854701a8f010808128a010a22313668747663424e53454137665a6841644c4a706844775152514a6148707948547012311080c08cbfa7051880e88887432222314a6d46614136756e724346594557504752693775755859314b7468544a784a45501a311080c08cbfa705188080a3c3472222314a6d46614136756e724346594557504752693775755859314b7468544a784a4550"
	index := int64(0)
	env, err := util.GenEnv(blockByte, index)
	assert.Nil(t, err)

	convert := common.NewConvert("", "bty", []string{transaction.TransactionX})
	records, err := convert.ConvertTx(env, db.SeqTypeAdd)
	assert.Nil(t, err)
	assert.Equal(t, 1, len(records))

	record, ok := records[0].(*transaction.TxRecord)
	assert.True(t, ok)
	assert.Equal(t, db.OpAdd, record.Op.OpType())
	assert.Equal(t, "transaction/transaction/0x27851fb51f63b74a12f996697864b13fabd1b54384ec8a2fd97d67c329f55e82", record.Key())
	tx := `{"height_index":16800000,"height":168,"block_time":1526542176,"block_hash":"0xb7a4fb09e854e4a60490b5573de2f4bf20bef027779b5e9f1b560e9fc1528529","success":true,"index":0,"hash":"0x27851fb51f63b74a12f996697864b13fabd1b54384ec8a2fd97d67c329f55e82","from":"1M4ns1eGHdHak3SNc2UTQB75vnXyJQd91s","to":"16htvcBNSEA7fZhAdLJphDwQRQJaHpyHTp","execer":"ticket","amount":0,"fee":100000,"action_name":"unknown","group_count":0,"is_withdraw":false,"options":null,"assets":[],"next":"","is_para":false}`
	assert.Equal(t, tx, string(record.Value()))
	//t.Log(string(record.Value()))
	//assert.False(t, ok)
}
